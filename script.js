
var figs =
[
// 0 дом
	[
		[
			[20, 50, 1],
			[50, 10, 2],
			[80, 50, 1],
			[80, 80, 3],
			[20, 80, 3]
		],
		[
			[0, 1],
			[1, 2],
			[2, 3],
			[2, 0],
			[2, 3],
			[3, 4],
			[4, 0]
		],
		[
			[
				[0, 4, 3, 2, 0],
				[[0, 2, 4], [4, 2, 3]]
			],
			[
				[0, 2, 1, 0],
				[[0, 2, 1]]
			]
		]
	],
// 1 песочные часы
	[
		[
			[20, 10, 1],
			[80, 10, 1],
			[20, 90, 3],
			[80, 90, 3],
			[50, 50, 2]
		],
		[
			[0, 4],
			[0, 1],
			[4, 1],
			[2, 4],
			[2, 3],
			[4, 3]
		],
		[
			[
				[4, 1, 0, 4],
				[[0, 1, 4]]
			],
			[
				[2, 3, 4, 2],
				[[2, 4, 3]]
			]
		]
	],
// 2 гриб
	[
		[
			[49, 9, 4],
			[10, 40, 1],
			[40, 40, 3],
			[60, 40, 3],
			[90, 40, 1],
			[40, 80, 2],
			[60, 80, 2]
		],
		[
			[6, 5],
			[5, 2],
			[2, 3],
			[3, 6],
			[3, 4],
			[1, 2],
			[1, 0],
			[0, 4]
		],
		[
			[
				[0, 1, 2, 3, 4, 0],
				[[1, 0, 4]]
			],
			[
				[5, 6, 3, 2, 5],
				[[3, 5, 2], [3, 5, 6]]
			]
		]
	],
// 3 конфета
	[
		[
			[10, 30, 1],
			[10, 70, 1],
			[30, 49, 2],
			[50, 30, 3],
			[50, 70, 3],
			[70, 50, 2],
			[90, 30, 4],
			[90, 70, 4]
		],
		[
			[0, 2],
			[0, 1],
			[2, 1],
			[3, 2],
			[2, 4],
			[3, 5],
			[4, 5],
			[5, 6],
			[6, 7],
			[5, 7]
		],
		[
			[
				[1, 2, 0, 1],
				[[0, 1, 2]]
			],
			[
				[2, 4, 5, 3, 2],
				[[2, 3, 4], [3, 4, 5]]
			],
			[
				[5, 7, 6, 5],
				[[5, 6, 7]]
			]
		]
	],
// 4 куб
	[
		[
			[10, 30, 1],
			[60, 30, 1],
			[60, 90, 2],
			[10, 90, 2],
			[40, 10, 3],
			[90, 10, 3],
			[90, 70, 4]
		],
		[
			[0, 1],
			[1, 2],
			[2, 3],
			[3, 0],
			[0, 4],
			[4, 5],
			[5, 1],
			[5, 6],
			[2, 6]
		],
		[
			[
				[0, 3, 2, 1, 0],
				[[0, 1, 3], [1, 3, 2]]
			],
			[
				[0, 1, 5, 4, 0],
				[[0, 1, 4], [1, 5, 4]]
			],
			[
				[2, 6, 5, 1, 2],
				[[1, 2, 6], [1, 6, 5]]
			]
		]
	], 
// 5 торт
	[

		[
			[40, 9, 1],
			[59, 9, 1],
			[24, 34, 2],
			[40, 34, 2],
			[59, 34, 2],
			[74, 34, 2],
			[10, 60, 3],
			[24, 60, 3],
			[74, 60, 3],
			[90, 60, 3],
			[10, 84, 4],
			[90, 84, 4]
		],
		[
			[0, 1],
			[0, 3],
			[2, 3],
			[3, 4],
			[1, 4],
			[4, 5],
			[2, 7],
			[6, 7],
			[7, 8],
			[5, 8],
			[8, 9],
			[6, 10],
			[10, 11],
			[9, 11]

		],
		[
			[
				[0, 3, 4, 1, 0],
				[[0, 3, 4], [0, 4, 1]]
			],
			[
				[7, 8, 5, 4, 3, 2, 7],
				[[7, 2, 5], [7, 5, 8]]
			],
			[
				[10, 11, 9, 8, 7, 6, 10],
				[[10, 9, 6], [10, 9, 11]]
			]
		]
	],
// 6 корона
	[
		[
			[10, 90, 1],
			[90, 90, 1],
			[90, 60, 3],
			[65, 60, 3],
			[35, 60, 3],
			[10, 60, 3],
			[10, 10, 2],
			[50, 10, 4],
			[89, 10, 2]
		],
		[
			[0, 1],
			[1, 2],
			[2, 3],
			[3, 4],
			[4, 5],
			[5, 0],
			[5, 6],
			[6, 4],
			[4, 7],
			[7, 3],
			[3, 8],
			[8, 2]

		],
		[
			[
				[0, 1, 2, 3, 4, 5, 0],
				[[0, 1, 2], [0, 2, 5]]
			],
			[
				[5, 4, 6, 5],
				[[5, 4, 6]]
			],
			[
				[4, 3, 7, 4],
				[[4, 3, 7]]
			],
			[
				[3, 2, 8, 3],
				[[3, 2, 8]]
			]
		]
	],
// 7 пирамидка
	[
		[
			[10, 90, 1],
			[30, 50, 2],
			[50, 10, 3],
			[69, 50, 2],
			[90, 89, 1],
			[49, 90, 4]
		],
		[
			[0, 1],
			[1, 2],
			[2, 3],
			[3, 4],
			[4, 5],
			[5, 0],
			[1, 3],
			[1, 5],
			[3, 5]
		],
		[
			[
				[0, 5, 1, 0],
				[[0, 5, 1]]
			],
			[
				[1, 3, 2, 1],
				[[1, 3, 2]]
			],
			[
				[5, 4, 3, 5],
				[[5, 4, 3]]
			],
			[
				[1, 5, 3, 1],
				[[1, 5, 3]]
			]
		]
	], 
// 8 сетка 
	[
		[
			[10, 10, 1],
			[50, 10, 4],
			[90, 10, 1],
			[10, 50, 2],
			[50, 50, 3],
			[90, 50, 2],
			[10, 90, 1],
			[50, 90, 4],
			[90, 90, 1]
		],
		[
			[0, 1],
			[1, 2],
			[3, 4],
			[4, 5],
			[6, 7],
			[7, 8],
			[0, 3],
			[1, 4],
			[2, 5],
			[3, 6],
			[4, 7],
			[5, 8]

		],
		[
			[
				[0, 3, 4, 1, 0],
				[[0, 1, 4], [0, 4, 3]]
			],
			[
				[1, 4, 5, 2, 1],
				[[1, 2, 5], [1, 5, 4]]
			],
			[
				[3, 6, 7, 4, 3],
				[[3, 4, 7], [3, 7, 6]]
			],
			[
				[4, 7, 8, 5, 4],
				[[4, 5, 8], [4, 7, 8]]
			]
		]
	],
// 9 нло
	[
		[
			[10, 50, 1],
			[24, 50, 2],
			[40, 50, 1],
			[60, 50, 2],
			[74, 50, 1],
			[90, 50, 2],
			[50, 20, 3],
			[50, 80, 4]
		],
		[
			[0, 6],
			[0, 7],
			[1, 6],
			[1, 7],
			[2, 6],
			[2, 7],
			[6, 3],
			[3, 7],
			[6, 4],
			[4, 7],
			[6, 5],
			[5, 7]
		],
		[
			[
				[0, 7, 1, 6, 0],
				[[0, 1, 7], [0, 1, 6]]
			],
			[
				[1, 7, 2, 6, 1],
				[[1, 2, 7], [1, 2, 6]]
			],
			[
				[2, 7, 3, 6, 2],
				[[2, 3, 7], [2, 3, 6]]
			],
			[
				[3, 7, 4, 6, 3],
				[[3, 4, 6], [3, 4, 7]]
			],
			[
				[7, 5, 6, 4, 7],
				[[4, 5, 7], [4, 5, 6]]
			]
		]
	], 
// 10 крест
	[
		[
			[49, 35, 2],
			[65, 50, 4],
			[50, 65, 2],
			[35, 50, 4],
			[30, 9, 3],
			[69, 10, 3],
			[90, 30, 1],
			[90, 70, 1],
			[70, 90, 3],
			[30, 90, 3],
			[10, 70, 1],
			[10, 30, 1]
		],
		[
			[0, 1],
			[1, 2],
			[2, 3],
			[3, 0],
			[4, 5],
			[5, 0],
			[0, 4],
			[6, 7],
			[7, 1],
			[1, 6],
			[8, 9],
			[9, 2],
			[2, 8],
			[10, 11],
			[11, 3],
			[3, 10]
		],
		[
			[
				[0, 3, 2, 1, 0],
				[[0, 1, 3], [1, 2, 3]]
			],
			[
				[0, 5, 4, 0],
				[[0, 5, 4]]
			],
			[
				[1, 7, 6, 1],
				[[1, 7, 6]]
			],
			[
				[2, 9, 8, 2],
				[[2, 9, 8]]
			],
			[
				[10, 3, 11, 10],
				[[10, 3, 11]]
			]
		]
	], 
// 11 рыба
	[
		[
			[10, 30, 3],
			[10, 70, 3],
			[25, 50, 1],
			[45, 34, 1],
			[45, 65, 1],
			[70, 30, 4],
			[70, 70, 4],
			[45, 10, 3],
			[44, 90, 3],
			[90, 50, 2]
		],
		[
			[0, 1],
			[1, 2],
			[0, 2],
			[2, 3],
			[3, 5],
			[5, 9],
			[9, 6],
			[6, 4],
			[4, 2],
			[7, 3],
			[7, 5],
			[4, 8],
			[6, 8],
			[5, 6]
		],
		[
			[
				[1, 2, 0, 1],
				[[1, 2, 0]]
			],
			[
				[3, 5, 7, 3],
				[[3, 5, 7]]
			],
			[
				[8, 6, 4, 8],
				[[8, 6, 4]]
			],
			[
				[6, 9, 5, 6],
				[[6, 9, 5]]
			],
			[
				[2, 4, 6, 5, 3, 2],
				[[2, 4, 3], [3, 4, 6], [3, 6, 5]]
			]
		]
	],
// 12 звезда
	[
		[
			[10, 39, 3],
			[37, 35, 1],
			[62, 34, 1],
			[90, 40, 3],
			[50, 10, 3],
			[30, 60, 1],
			[70, 60, 1],
			[50, 74, 2],
			[24, 89, 4],
			[74, 90, 4]
		],
		[
			[0, 1],
			[1, 4],
			[4, 2],
			[2, 3],
			[3, 6],
			[6, 9],
			[9, 7],
			[7, 8],
			[8, 5],
			[5, 0],
			[5, 1],
			[1, 2],
			[2, 6],
			[6, 7],
			[7, 5]
		],
		[
			[
				[0, 5, 1, 0],
				[[0, 5, 1]]
			],
			[
				[1, 2, 4, 1],
				[[1, 2, 4]]
			],
			[
				[6, 3, 2, 6],
				[[6, 3, 2]]
			],
			[
				[7, 9, 6, 7],
				[[7, 9, 6]]
			],
			[
				[8, 7, 5, 8],
				[[8, 7, 5]]
			],
			[
				[5, 7, 6, 2, 1, 5],
				[[5, 7, 1], [7, 6, 1], [6, 2, 1]]
			]
		]
	], 
// 13 Єлка
	[
		[
			[50, 10, 1],
			[40, 30, 2],
			[30, 50, 2],
			[20, 70, 2],
			[10, 90, 4],
			[63, 36, 3],
			[76, 62, 3],
			[90, 90, 4]
		],
		[
			[0, 1],
			[1, 2],
			[2, 3],
			[3, 4],
			[4, 7],
			[7, 6],
			[6, 5],
			[5, 0],
			[1, 5],
			[5, 2],
			[2, 6],
			[6, 3],
			[3, 7]
		],
		[
			[
				[0, 1, 5, 0],
				[[0, 1, 5]]
			],
			[
				[2, 5, 1, 2],
				[[2, 5, 1]]
			],
			[
				[2, 6, 5, 2],
				[[2, 6, 5]]
			],
			[
				[3, 6, 2, 3],
				[[3, 6, 2]]
			],
			[
				[3, 7, 6, 3],
				[[3, 7, 6]]
			],
			[
				[4, 7, 3, 4],
				[[4, 7, 3]]
			]
		]
	], 
// 14 кракоз€бра
	[
		[
			[18, 29, 3],
			[30, 39, 1],
			[23, 54, 2],
			[15, 70, 3],
			[42, 10, 4],
			[52, 28, 2],
			[64, 50, 1],
			[72, 16, 3],
			[49, 89, 2],
			[84, 64, 1],
			[43, 51, 4]
		],
		[
			[3, 2],
			[2, 1],
			[0, 2],
			[0, 1],
			[1, 10],
			[3, 8],
			[8, 10],
			[0, 4],
			[4, 5],
			[5, 6],
			[6, 10],
			[8, 9],
			[7, 4],
			[5, 7],
			[7, 9],
			[8, 6]

		],
		[
			[
				[0, 2, 1, 0],
				[[0, 2, 1]]
			],
			[
				[3, 8, 10, 1, 2, 3],
				[[2, 10, 1], [2, 3, 8], [2, 10, 8]]
			],
			[
				[10, 8, 6, 10],
				[[10, 8, 6]]
			],
			[
				[0, 1, 10, 6, 5, 4, 0],
				[[0, 4, 6], [0, 6, 10]]
			],
			[
				[4, 5, 7, 4],
				[[4, 5, 7]]
			],
			[
				[8, 9, 7, 5, 6, 8],
				[[5, 7, 6], [7, 6, 9], [8, 9, 6]]
			]
		]
	] 
]

var el, waveOn, canvas, pos, mode, steps, comePos, rot, rotPos, proc, dir, ind, selFig, msel, figSel, mmFigSel, mmSelFig, blink;
var xod, click, pobeda, gamePos, porarr, naparr, demoMode, demoPos, demoAct, redBlink, retMenu, autoSize, maxSteps, nBlink;

function init() {
	el = document.getElementById("canv");
	el.addEventListener("mousedown", mdn);
	el.addEventListener("mousemove", mmv);
	el.addEventListener("mouseout", mout);
	canvas = el.getContext("2d");
	xod = new Audio();
	xod.src = "xod.wav";
	xod.load();
	pobeda = new Audio();
	pobeda.src = "pobeda.wav";
	pobeda.load();
	click = new Audio();
	click.src = "click.wav";
	click.load();
	waveOn = true;
	mode = 2;
	steps = 0;
	rot = 1;
	msel = -1;
	figSel = -1;
	mmFigSel = -1;
	comePos = 0.0;
	proc = false;
	demoMode = false;
	dir = 1;
	blink = true;
	nBlink = false;
	retMenu = false;
	selFig = [];
	mmSelFig = [];
	autoSize = true;
	canvas.font = "bold "+el.height/4.0+"px Arial";
	gamePos = [1, 2, 1, 3, 3, 1, 2, 1, 1, 3, 1, 2];
//	drawMode2();
	rsizeCanvas();
	menuBlink();
	numBlink();
}

function getClientWidth(){
	return document.compatMode=='CSS1Compat' &&
		!window.opera?document.documentElement.clientWidth:document.body.clientWidth;
}
 
function getClientHeight(){
	return document.compatMode=='CSS1Compat' &&
		!window.opera?document.documentElement.clientHeight:document.body.clientHeight;
}

function rsizeCanvas() {
	if (!autoSize) {
		return;
	}
	if (proc) {
		setTimeout("rsizeCanvas()", 500);
		return;
	}
	var wx = getClientWidth()*0.9;//document.documentElement.clientWidth;
	var wy = getClientHeight()*0.9;//document.documentElement.clientHeight;
	if (wx < 60) {
		wx = 60;
	}
	if (wx < 40) {
		wx = 40;
	}
	el.width = Math.min(wx, wy*600.0/400.0);
	el.height = Math.min(wx*400.0/600.0, wy);
	canvas.font = "bold "+el.height/4.0+"px Arial";
	mout();
}

function winSizeChange(i) {
	if (i == 0) {
		autoSize = true;
		rsizeCanvas();
		return;
	}
	autoSize = false;
	el.width = 400+i*200;
	el.height = 200+i*200;
	canvas.font = "bold "+el.height/4.0+"px Arial";
	canvas.fillStyle = "#ffffaa";
	canvas.fillRect(0, 0, 1000, 800);
	switch (mode) {
	case 0:
	case 1:
		drawMode1();
		break;
	case 2:
		drawMode2();
		break;
	}
}

function waveOnOff() {
	waveOn = ! waveOn;
}

function getColor(i) {
	switch (i) {
	case 1:
		return "#ff0000";
	case 2:
		return "#00ff00";
	case 3:
		return "#0000ff";
	case 4:
		return "#008888";
	}
}

function drawFig(x, y, w, h) {
	var kx = w/100.0, ky = h/100.0;
	var pnts = figs[ind][0];
	var lines = figs[ind][1];
	var pntsCnt = pnts.length;
	var linesCnt = lines.length;
	var i, j;
	if (selFig.length > 0) {
		canvas.fillStyle = "#ccccff";
		canvas.beginPath();
		canvas.moveTo(pnts[selFig[0]][0]*kx+x, pnts[selFig[0]][1]*ky+y);
		for (i = 1; i < selFig.length; ++i) {
			canvas.lineTo(pnts[selFig[i]][0]*kx+x, pnts[selFig[i]][1]*ky+y);
		}
		canvas.fill();
	}
	if (mmSelFig.length > 0) {
		canvas.globalAlpha = 0.5;
		canvas.fillStyle = "#ffcccc";
		canvas.beginPath();
		canvas.moveTo(pnts[mmSelFig[0]][0]*kx+x, pnts[mmSelFig[0]][1]*ky+y);
		for (i = 1; i < mmSelFig.length; ++i) {
			canvas.lineTo(pnts[mmSelFig[i]][0]*kx+x, pnts[mmSelFig[i]][1]*ky+y);
		}
		canvas.fill();
		canvas.globalAlpha = 1.0;
	}
	canvas.strokeStyle = "#bbbbbb";
	canvas.lineWidth = kx;
	canvas.beginPath();
	for (i = 0; i < linesCnt; ++i) {
		var pnt1 = lines[i][0];
		var pnt2 = lines[i][1];
		canvas.moveTo(pnts[pnt1][0]*kx+x, pnts[pnt1][1]*ky+y);
		canvas.lineTo(pnts[pnt2][0]*kx+x, pnts[pnt2][1]*ky+y);
	}
	canvas.stroke();
	for (i = 0; i < pntsCnt; ++i) {
		canvas.fillStyle = getColor(pnts[i][2]);
		canvas.beginPath();
		canvas.arc(pnts[i][0]*kx+x, pnts[i][1]*ky+y, 4*kx, 0, 100, false); 
		canvas.fill();
	}
	for (i = 0; i < pntsCnt; ++i) {
		canvas.fillStyle = "#ffffff";
		canvas.beginPath();
		canvas.arc(pnts[i][0]*kx+x, pnts[i][1]*ky+y, 3*kx, 0, 100, false); 
		canvas.fill();
	}
	for (i = 0; i < pntsCnt; ++i) {
		var indOf = selFig.indexOf(i);
		indOf = (indOf == 0 && rot < 0) ? selFig.length-1 : indOf;
		if (pos > 0.0 && indOf >= 0) {
			canvas.fillStyle = getColor(gamePos[selFig[indOf+rot]]);
			canvas.beginPath();
			var x1 = pnts[i][0];
			var x2 = pnts[selFig[indOf+rot]][0];
			var y1 = pnts[i][1];
			var y2 = pnts[selFig[indOf+rot]][1];
			canvas.arc((x1*pos+x2*(1.0-pos))*kx+x, (y1*pos+y2*(1.0-pos))*ky+y, 3*kx, 0, 100, false); 
			canvas.fill();

		}
		else {
			canvas.fillStyle = getColor(gamePos[i]);
			canvas.beginPath();
			canvas.arc(pnts[i][0]*kx+x, pnts[i][1]*ky+y, 3*kx, 0, 100, false); 
			canvas.fill();
		}
//		canvas.fillStyle = 0;
//		canvas.fillText(""+i, pnts[i][0]*kx+x, pnts[i][1]*ky+y);
	}
	canvas.strokeStyle = "#ffffff";
	canvas.lineWidth = 1;
	for (i = 0; i < pntsCnt; ++i) {
		if (!(pos > 0.0 && selFig.indexOf(i) >= 0)) {
			canvas.beginPath();
			canvas.arc(pnts[i][0]*kx+x, pnts[i][1]*ky+y, 3*kx, 0, 100, false); 
			canvas.stroke();
		}
	}
	if (mode == 1) {
		canvas.globalAlpha = 0.4;
		canvas.fillStyle = canvas.strokeStyle =
			(rot > 0.0 && Math.sin(pos*15.0) > 0.0) ? "#ffffff" : (msel == 1 ? "#ff0000" : "#ff00ff");
		canvas.lineWidth = kx*3;
		var cX = el.width*(1.0-1.0/8.0);
		var cY = el.height*(1.0-1.0/8.0)-10;
		var r = el.width/14.0;
		canvas.beginPath();
		canvas.arc(cX, cY, r, Math.PI*0.5, Math.PI*2.0, false); 
		canvas.stroke();
		canvas.beginPath();
		canvas.moveTo(cX+r, cY+r*0.7);
		canvas.lineTo(cX+r*1.6, cY);
		canvas.lineTo(cX+r*0.4, cY);
		canvas.lineTo(cX+r, cY+r*0.7);
		canvas.fill();
		canvas.fillStyle = canvas.strokeStyle =
			(rot < 0.0 && Math.sin(pos*15.0) > 0.0) ? "#ffffff" : (msel == 2 ? "#ff0000" : "#ff00ff");
		canvas.lineWidth = kx*3;
		cX = el.width*(1.0/8.0);
		canvas.beginPath();
		canvas.arc(cX, cY, r, Math.PI, Math.PI*2.5, false); 
		canvas.stroke();
		canvas.beginPath();
		canvas.moveTo(cX-r, cY+r*0.7);
		canvas.lineTo(cX-r*1.6, cY);
		canvas.lineTo(cX-r*0.4, cY);
		canvas.lineTo(cX-r, cY+r*0.7);
		canvas.fill();
		cY = el.height*(1.0/8.0)+10;
		if (demoMode) {
			if (nBlink) {
				canvas.fillStyle = "#ff0000";
				canvas.beginPath();
				canvas.arc(cX, cY, r/2.0, 0, 100, false);
				canvas.fill();
			}
		}
		else {
			canvas.fillStyle = canvas.strokeStyle = (msel == 3 ? "#ff0000" : "#ff00ff");
			canvas.beginPath();
			canvas.arc(cX, cY, r, 0, 100, false); 
			canvas.stroke();
			canvas.beginPath();
			canvas.arc(cX, cY, r/5, 0, 100, false); 
			canvas.fill();
		}
		if (steps <= maxSteps || nBlink) {
			canvas.fillStyle = canvas.strokeStyle = "#ff00ff";
			canvas.textAlign = "center";
			canvas.textBaseline = "middle";
			cX = el.width*(1.0-1.0/8.0);
			cY = el.height*(1.0/8.0)+10;
			canvas.fillText(steps, cX, cY);
		}
		canvas.globalAlpha = 1.0;
	}
}

function dist(x1, y1, x2, y2) {
	return Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));
}


function triS(x1, y1, x2, y2, x3, y3) {
	return Math.abs(0.5*(x1*(y2-y3)+x2*(y3-y1)+x3*(y1-y2)));
}

function pInTri(xp, yp, x1, y1, x2, y2, x3, y3) {
	var s1 = triS(xp, yp, x1, y1, x2, y2);
	var s2 = triS(xp, yp, x2, y2, x3, y3);
	var s3 = triS(xp, yp, x3, y3, x1, y1);
	var s = triS(x1, y1, x2, y2, x3, y3);
	return (s1+s2+s3 <= s+1.0);
}

function pInPath(x, y, pnts, ts) {
	var tslen = ts.length;
	for (var i = 0; i < tslen; ++i) {
		var t = ts[i];
		if (pInTri(
			x, y,
			pnts[t[0]][0], pnts[t[0]][1],
			pnts[t[1]][0], pnts[t[1]][1],
			pnts[t[2]][0], pnts[t[2]][1]
		)) {
			return true;
		}
	}
	return false;
}

function pInFig(x, y) {
	var i, j;
	var paths = figs[ind][2].length;
	var points = figs[ind][0];
	for (i = 0; i < paths; ++i) {
		var path = figs[ind][2][i];
		if (pInPath(x, y, points, path[1])) {
			if (mmFigSel >= 0) {
				mmSelFig = path[0];
				mmFigSel = i;
			}
			else {
				selFig = path[0];
			}
			return true;
		}
	}
	return false;
}

function drawMode1() {
	canvas.fillStyle = "#ffffaa";
	canvas.fillRect(0, 0, el.width, el.height);
	drawFig(0, 0, el.width, el.height);
}

function drawMode2() {
	var i, j, tmpInd = ind;
	canvas.fillStyle = "#ffffaa";
	canvas.fillRect(0, 0, el.width, el.height);
	var kx = el.width/4.0;
	var ky = el.height/4.0;
	for (i = 0; i < 4; ++i) {
		for (j = 0; j < 4; ++j) {
			var p = i+j*4;
			if (p == figSel) {
				canvas.fillStyle = "#ddddff";
				canvas.fillRect(i*kx, j*ky, kx, ky);
			}
			if (p == 15) {
				continue;
			}
			if (figs[p] != -1) {
				ind = p;
				drawFig(i*kx, j*ky, kx, ky);
			}
		}
	}
	var qr = Math.random() > 0.5 ? 127 : 64;
	var qg = Math.random() > 0.5 ? 127 : 64;
	var qb = Math.random() > 0.5 ? 127 : 64;
	canvas.fillStyle = "rgba("+Math.floor(qr)+", "+Math.floor(qg)+", "+Math.floor(qb)+", 1.0)";
	canvas.strokeStyle = "#555555";
	canvas.lineWidth = el.width/200.0;
	canvas.textAlign = "center";
	canvas.textBaseline = "middle";
	canvas.fillText("?", el.width*(1.0-1.0/8.0), el.height*(1.0-1.0/8.0+0.02));
	canvas.strokeText("?", el.width*(1.0-1.0/8.0), el.height*(1.0-1.0/8.0+0.02));
	ind = tmpInd;
}

function mkFig() {
	var fcnt = figs[ind][2].length;
	porarr = [];
	naparr = [];
	var i, j;
	for (i = 0; i < fcnt*2; ++i) {
		porarr.push(Math.floor(i/2.0));
	}
	do {
		for (i = 0; i < fcnt*2; ++i) {
			var rnd = Math.floor(Math.random()*fcnt);
			var tmp = porarr[i];
			porarr[i] = porarr[rnd];
			porarr[rnd] = tmp;
			naparr.push(Math.floor(Math.random()*2) == 0 ? -1 : 1);
		}
		var rep = false;
		for (i = 1; i < fcnt*2; ++i) {
			if (porarr[i-1] == porarr[i]) {
				rep = true;
				break;
			}
		}
	}
	while (rep);
	var pcnt = figs[ind][0].length;
	gamePos = [];
	for (i = 0; i < pcnt; ++i) {
		gamePos.push(figs[ind][0][i][2]);
	}
	for (i = 0; i < fcnt*2; ++i) {
		rot = naparr[i];
		selFig = figs[ind][2][porarr[i]][0];
		arrRot();	
	}
	var cnt = 0;
	for (i = 0; i < pcnt; ++i) {
		if (gamePos[i] == figs[ind][0][i][2]) {
			++cnt;
		}
	}
	if (pcnt == 2 && cnt > pcnt/2.0 || cnt > pcnt/3.0) {
		mkFig();
	}
	selFig = [];
}

function ifReady() {
	var pcnt = figs[ind][0].length;
	for (var i = 0; i < pcnt; ++i) {
		if (gamePos[i] != figs[ind][0][i][2]) {
			return false;
		}
	}
	return true;
}

function mdn(obj) {
	if (demoMode) {
		retMenu = true;
		if (waveOn) {
			click.play();
		}
	}
	if (proc) {
		return;
	}
	var x = obj.clientX-el.offsetLeft+window.pageXOffset;
	var y = obj.clientY-el.offsetTop+window.pageYOffset;
	if (mode != 1) {
		ind = Math.floor(x*4/el.width)+4*Math.floor(y*4/el.height);
		if (ind == 15) {
			demoMode = true;
			ind = Math.floor(Math.random()*15.0);
		}
		mode = 0;
		proc = true;
		dir = 1;
		steps = 0;
		maxSteps = figs[ind][2].length*2;
		comePos = 0.0;
		figSel = -1;
		blink = false;
		mkFig();
		if (waveOn) {
			click.play();
		}
		figCome();
		return;
	}
	var cX = el.width*(1.0-1.0/8.0);
	var cY = el.height*(1.0-1.0/8.0)-10;
	var r = el.width/14.0;
	if (dist(x, y, cX, cY) < r) {
		if (selFig.length <= 0) {
			return;
		}
		proc = true;
		rot = 1;
		pos = 0.0;
		if (waveOn) {
			xod.play();
		}
		figRot();
		++steps;
		return;
	}
	cX = el.width*(1.0/8.0);
	if (dist(x, y, cX, cY) < r) {
		if (selFig.length <= 0) {
			return;
		}
		proc = true;
		rot = -1;
		pos = 0.0;
		if (waveOn) {
			xod.play();
		}
		figRot();
		++steps;
		return;
	}
	cY = el.height*(1.0/8.0)+10;
	if (dist(x, y, cX, cY) < r) {
		demoMode = false;
		proc = true;
		comePos = 1.0;
		dir = -1;
		msel = -1;
		mode = 0;
		selFig = [];
		mmSelFig = [];
	 	gamePos = [1, 2, 1, 3, 3, 1, 2, 1, 1, 3, 1, 2];
		if (waveOn) {
			click.play();
		}
		figCome();
		return;
	}
	mmFigSel = -1;
	if (pInFig(x*100.0/el.width, y*100.0/el.height)) {
		if (waveOn) {
			click.play();
		}
		drawMode1()
		return;
	}
	selFig = [];
	mmSelFig = [];
	drawMode1();
}

function mmv(obj) {
	if (proc || demoMode) {
		return;
	}
	var x = obj.clientX-el.offsetLeft+window.pageXOffset;
	var y = obj.clientY-el.offsetTop+window.pageYOffset;
	var target;
	try {
		target = window.event.srcElement;
	}
	catch (e) {
		target = {style: 0};
		target.style = {cursor: 0};
	}
	if (mode != 1) {
		target.style.cursor = "hand";
		var oldFigSel = figSel;
		figSel = Math.floor(x*4/el.width)+4*Math.floor(y*4/el.height);
		if (figSel != oldFigSel) {
			drawMode2();
		}
		return;
	}
	var cX = el.width*(1.0-1.0/8.0);
	var cY = el.height*(1.0-1.0/8.0)-10;
	var r = el.width/14.0;
	if (dist(x, y, cX, cY) < r) {
		if (msel == 1) {
			return;
		}
		target.style.cursor = "hand";
		msel = 1;
		mmSelFig = [];
		drawMode1();
		return;
	}
	cX = el.width*(1.0/8.0);
	if (dist(x, y, cX, cY) < r) {
		if (msel == 2) {
			return;
		}
		target.style.cursor = "hand";
		msel = 2;
		mmSelFig = [];
		drawMode1();
		return;
	}
	//cX = el.width*0.5;
	cY = el.height*(1.0/8.0)+10;
	if (dist(x, y, cX, cY) < r) {
		if (msel == 3) {
			return;
		}
		target.style.cursor = "hand";
		msel = 3;
		mmSelFig = [];
		drawMode1();
		return;
	}
	if (msel >= 0) {
		target.style.cursor = "default";
		msel = -1;
		drawMode1();
		return;
	};
	msel = -1;
	var oldMmFigSel = mmFigSel;
	mmFigSel = 1000;
	if (pInFig(x*100.0/el.width, y*100.0/el.height)) {
		target.style.cursor = "hand";
		if (mmFigSel != oldMmFigSel) {
			drawMode1();
		}
		return;
	}
	target.style.cursor = "default";
	if (mmSelFig.length > 0) {
		mmSelFig = [];
		drawMode1();
	}
}

function mout() {
	if (proc) {
		return;
	}
	msel = -1;
	figSel = -1;
	switch (mode) {
	case 0:
	case 1:
		mmSelFig = [];
		drawMode1();
		break;
	case 2:
		drawMode2();
		break;
	}
}

function menuBlink() {
	if (!blink) {
		return;
	}
	gamePos[Math.floor(Math.random()*12.0)] = Math.floor(1.0+Math.random()*4.0);
	drawMode2();
	setTimeout("menuBlink()", 100);
}

function numBlink() {
	nBlink = !nBlink;
	if (mode == 1 && !proc && (steps > maxSteps || demoMode)) {
		drawMode1();
	}
	setTimeout("numBlink()", 500);
}

function figCome() {
	if (dir > 0 && comePos >= 1.0) {
		mode = 1;
		drawMode1();
		proc = false;
		if (demoMode) {
			demo(0);
		}
		return;
	}
	if (dir < 0 && comePos <= 0.0) {
		demoMode = false
		canvas.fillStyle = "#ffffaa";
		canvas.fillRect(0, 0, 1000, 800);
		mode = 2;
		drawMode2();
		proc = false;
		blink = true;
		menuBlink();
		return;
	}
	drawMode2();
	canvas.fillStyle = "#ffffaa";
	canvas.globalAlpha = comePos;
	canvas.fillRect(0, 0, 1000, 800);
	canvas.globalAlpha = 1.0;
	drawFig(el.width*(1.0-comePos)/2.0, el.height*(1.0-comePos)/2.0, el.width*comePos,  el.height*comePos);
	comePos += 0.05*dir;
	setTimeout("figCome()", 50);
}

function arrRot() {
	if (rot > 0) {
		var tmp = gamePos[selFig[0]];
		for (var i = 0; i < selFig.length-1; ++i) {
			gamePos[selFig[i]] = gamePos[selFig[i+1]];
		}
		gamePos[selFig[selFig.length-2]] = tmp;
	}
	else {
		var tmp = gamePos[selFig[selFig.length-2]];
		for (var i = selFig.length-2; i > 0; --i) {
			gamePos[selFig[i]] = gamePos[selFig[i-1]];
		}
		gamePos[selFig[0]] = tmp;
	}
}

function figRot() {
	if (pos >= 1.0) {
		pos = 0.0;
		arrRot();
		drawMode1();
		proc = false;
		if (ifReady()) {
			demoMode = false;
			if (waveOn) {
				pobeda.play();
			}
			proc = true;
			mode = 0;
			rotPos = 0.0;
			msel = -1;
			selFig = [];
			canvas.translate(el.width/2,  el.height/2);
			canvas.save();
			finRot();
		}
		if (demoMode) {
			demo(1);
		}
		return;
	}
	drawMode1();
	pos += 0.07;
	setTimeout("figRot()", 50);
}

function finRot() {
	if (rotPos >= Math.PI*9.5) {
		canvas.restore();
		canvas.translate(-el.width/2,  -el.height/2);
		comePos = 1.0
		dir = -1;
		figCome();
		return;
	}
	canvas.fillStyle = "#ffffaa";
	canvas.fillRect(-el.width/2, -el.height/2, el.width,  el.height);
	canvas.rotate(0.1);
	drawFig(-el.width/2, -el.height/2, el.width,  el.height);
	rotPos += 0.5;
	setTimeout("finRot()", 50);
}

function demo(act) {
	if (!demoMode) {
		return;
	}
	if (retMenu && !proc) {
		retMenu = false;
		demoMode = false;
		proc = true;
		comePos = 1.0;
		dir = -1;
		msel = -1;
		mode = 0;
		selFig = [];
		mmSelFig = [];
	 	gamePos = [1, 2, 1, 3, 3, 1, 2, 1, 1, 3, 1, 2];
		figCome();
		return;
	}
	if (act == 0) {
		redBlink = false;
		demoPos = porarr.length-1;
		demoAct = -1;
	}
	++demoAct;
	switch (demoAct) {
	case 0:
		break;
	case 1:
		selFig = figs[ind][2][porarr[demoPos]][0];
		drawMode1();
		break;
	case 2:
		break;
	case 3:
		proc = true;
		rot = -naparr[demoPos];
		pos = 0.0;
		if (waveOn) {
			xod.play();
		}
		++steps;
		demoAct = -1;
		--demoPos;
		figRot();
		return;
	}
	setTimeout("demo(1)", 500);
}

window.onresize = rsizeCanvas;
window.addEventListener("load", init, false);